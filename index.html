<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bryce's Recomp</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- Chart.js for data visualization --><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    /* CSS Variables for Color and Spacing */
    :root {
      --bg: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      --panel: rgba(26, 26, 36, 0.85);
      --panel-2: rgba(30, 30, 40, 0.75);
      --panel-hover: rgba(35, 35, 45, 0.85);
      --ink: #E8E8E8;
      --muted: #A0A0B0;
      --line: #2A2A3A;
      --accent: #FFB84D;
      --accent-glow: rgba(255, 184, 77, 0.3);
      --info: #4FC3F7;
      --info-glow: rgba(79, 195, 247, 0.25);
      --danger: #FF6B6B;
      --danger-glow: rgba(255, 107, 107, 0.25);
      --success: #51CF66;
      --radius: 16px;
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
      --backdrop-filter: blur(16px) saturate(180%);
      --border-glass: 1px solid rgba(255, 255, 255, 0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* NEW: Intensity Colors */
      --color-compound: var(--accent); /* Orange/Gold */
      --color-isolation: var(--info);   /* Light Blue */
      --color-progress: var(--success); /* Green */
    }
    /* Base Styles */
    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--ink);
      background: #0a0a0a;
      background-image:
          radial-gradient(at 0% 0%, rgba(255, 184, 77, 0.05) 0px, transparent 50%),
          radial-gradient(at 100% 100%, rgba(79, 195, 247, 0.05) 0px, transparent 50%);
      background-attachment: fixed;
      line-height: 1.7;
      font-weight: 400;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 60px auto;
      padding: 48px 40px;
      background: var(--panel);
      border: var(--border-glass);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      backdrop-filter: var(--backdrop-filter);
      -webkit-backdrop-filter: var(--backdrop-filter);
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Fullscreen Mode Styles */
    .fullscreen-mode .container {
        max-width: none !important;
        margin: 0 !important;
        padding: 20px !important;
        min-height: 100vh;
        width: 100vw;
        border-radius: 0;
        box-shadow: none;
        transition: all 0.5s ease-in-out;
    }
    .fullscreen-mode h1,
    .fullscreen-mode .tab-labels,
    .fullscreen-mode .divider,
    .fullscreen-mode .full-screen-btn-container, /* Hides the button used to enter FS */
    .fullscreen-mode .workout-history,
    .fullscreen-mode .tracker-controls {
        display: none !important;
    }
    .fullscreen-mode #content-5 {
        display: block !important;
        height: 100%;
    }
    .fullscreen-mode .color-code-box.tracker {
        padding: 20px;
    }
    .fullscreen-mode .fullscreen-toggle-button { /* Shows the button used to exit FS */
        display: block !important;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 8px 16px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, var(--danger), rgba(255, 107, 107, 0.8));
        color: var(--ink);
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--danger-glow);
        cursor: pointer;
    }


    /* Typography */
    h1 {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent);
      font-size: clamp(2rem, 4vw, 3rem);
      text-align: center;
      text-transform: uppercase;
      font-weight: 800;
      letter-spacing: 3px;
      margin: 0 0 12px;
      text-shadow: 0 0 40px var(--accent-glow);
      position: relative;
      padding-bottom: 24px;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      border-radius: 2px;
    }

    h2 {
      color: var(--info);
      font-size: 1.5rem;
      margin: 36px 0 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(79, 195, 247, 0.3);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 1px;
      text-shadow: 0 0 20px var(--info-glow);
    }

    h3 {
      font-size: 1.1rem;
      margin: 24px 0 14px;
      color: var(--accent);
      font-weight: 600;
      padding-left: 16px;
      border-left: 3px solid var(--accent);
      background: linear-gradient(90deg, var(--accent-glow), transparent);
      padding: 10px 16px;
      border-radius: 4px;
    }
    
    .muted {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .data-label {
      font-family: 'JetBrains Mono', monospace;
      color: var(--info);
      font-weight: 600;
      padding: 2px 8px;
      background: rgba(79, 195, 247, 0.1);
      border-radius: 4px;
      font-size: 0.9em;
    }

    /* Tab System */
    .tab-container {
      display: flex;
      flex-direction: column;
      margin-top: 32px;
    }

    .tab-labels {
      display: grid;
      /* Adjusted to fit 6 tabs, 3 on mobile */
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-bottom: 32px;
    }

    .tab-input {
      display: none;
    }

    .tab-label {
      padding: 18px 16px;
      background: var(--panel-2);
      border: var(--border-glass);
      color: var(--muted);
      text-align: center;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 1.2px;
      cursor: pointer;
      border-radius: var(--radius);
      transition: var(--transition);
      backdrop-filter: var(--backdrop-filter);
      -webkit-backdrop-filter: var(--backdrop-filter);
      position: relative;
      overflow: hidden;
      font-size: 0.9rem;
    }

    .tab-label::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .tab-label:hover {
      background: var(--panel-hover);
      color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .tab-label:hover::before {
      left: 100%;
    }

    .tab-input:checked + .tab-label {
      background: linear-gradient(135deg, rgba(255, 184, 77, 0.2), rgba(79, 195, 247, 0.2));
      color: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 8px 32px var(--accent-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transform: scale(1.02);
    }

    .tab-input:checked + .tab-label::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #tab-1:checked ~ #content-1,
    #tab-2:checked ~ #content-2,
    #tab-3:checked ~ #content-3,
    #tab-4:checked ~ #content-4,
    #tab-5:checked ~ #content-5,
    #tab-6:checked ~ #content-6 {
      display: block;
    }

    /* Divider */
    .divider {
      height: 2px;
      border: 0;
      background: linear-gradient(90deg, transparent, var(--accent) 50%, transparent);
      margin: 24px 0 32px;
      opacity: 0.8;
    }

    /* Boxes */
    .color-code-box {
      padding: 32px;
      border-radius: var(--radius);
      background: var(--panel-2);
      border: var(--border-glass);
      margin-bottom: 28px;
      backdrop-filter: var(--backdrop-filter);
      -webkit-backdrop-filter: var(--backdrop-filter);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .color-code-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      transition: var(--transition);
    }

    .color-code-box:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .training::before {
      background: linear-gradient(90deg, var(--accent), transparent);
      box-shadow: 0 0 24px var(--accent-glow);
    }

    .nutrition::before {
      background: linear-gradient(90deg, var(--info), transparent);
      box-shadow: 0 0 24px var(--info-glow);
    }

    .compounds::before {
      background: linear-gradient(90deg, var(--danger), transparent);
      box-shadow: 0 0 24px var(--danger-glow);
    }

    .tracker::before, .analytics::before {
      background: linear-gradient(90deg, var(--success), transparent);
      box-shadow: 0 0 24px rgba(81, 207, 102, 0.25);
    }

    /* Lists */
    ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    ul li {
      position: relative;
      padding-left: 28px;
      margin-bottom: 12px;
      transition: var(--transition);
    }

    ul li:hover {
      padding-left: 32px;
    }

    ul li::before {
      content: "▸";
      position: absolute;
      left: 0;
      top: 0;
      color: var(--accent);
      font-weight: 700;
      font-size: 1.2em;
      line-height: 1.4;
    }

    /* Grid */
    .phase-grid, .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 20px;
    }

    .phase-grid > div, .analytics-grid > div {
      background: rgba(0, 0, 0, 0.2);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
      min-height: 100%;
    }

    .phase-grid > div:hover, .analytics-grid > div:hover {
      background: rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-4px);
    }
    
    /* Charts */
    .chart-container {
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        margin-bottom: 24px;
        max-height: 400px; /* Limit chart height */
    }
    .chart-container canvas {
        width: 100% !important;
        height: auto !important;
    }
    
    /* PR List */
    .pr-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .pr-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 12px 16px;
        border-radius: 8px;
        border-left: 4px solid var(--accent);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: 'JetBrains Mono', monospace;
    }
    .pr-exercise {
        color: var(--info);
        font-weight: 600;
        font-size: 0.9rem;
    }
    .pr-details {
        text-align: right;
    }
    .pr-volume {
        color: var(--accent);
        font-weight: 800;
        font-size: 1.1rem;
    }


    /* Tables */
    .table-wrap {
      overflow-x: auto;
      border: var(--border-glass);
      border-radius: var(--radius);
      backdrop-filter: var(--backdrop-filter);
      -webkit-backdrop-filter: var(--backdrop-filter);
      background: rgba(0, 0, 0, 0.2);
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    th {
      background: rgba(79, 195, 247, 0.15);
      color: var(--info);
      padding: 16px 12px;
      text-align: left;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
      border-bottom: 2px solid rgba(79, 195, 247, 0.3);
    }

    td {
      padding: 14px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    tr:last-child td {
      border-bottom: none;
    }

    td strong {
      color: var(--accent);
      font-weight: 600;
    }

    /* Rest Timer Styles */
    .rest-timer-container {
      background: rgba(0, 0, 0, 0.3);
      padding: 32px;
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      max-width: 600px;
      margin: 24px auto 0;
    }

    .timer-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(3rem, 8vw, 5rem);
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 0 30px var(--accent-glow);
      margin-bottom: 24px;
      letter-spacing: 4px;
    }

    .timer-display.running {
      color: var(--success);
      text-shadow: 0 0 30px rgba(81, 207, 102, 0.5);
      animation: pulse 1s ease-in-out infinite;
    }

    .timer-display.finished {
      color: var(--danger);
      text-shadow: 0 0 30px var(--danger-glow);
      animation: flash 0.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    @keyframes flash {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .timer-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .timer-preset {
      padding: 12px 20px;
      background: var(--panel-2);
      border: var(--border-glass);
      border-radius: 8px;
      color: var(--ink);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.95rem;
    }

    .timer-preset:hover {
      background: var(--panel-hover);
      color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .timer-custom {
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .timer-custom input {
      padding: 12px 16px;
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: var(--ink);
      font-family: 'JetBrains Mono', monospace;
      font-size: 1rem;
      text-align: center;
      transition: var(--transition);
      -moz-appearance: textfield; /* Hide arrows in Firefox */
    }

    .timer-custom input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .timer-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .timer-progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 20px;
    }

    .timer-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--info));
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px var(--success);
    }

    .btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--accent), rgba(255, 184, 77, 0.8));
      border: none;
      border-radius: 8px;
      color: #000;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    .btn-secondary {
      padding: 12px 24px; /* Default padding for secondary */
      background: var(--panel-2); /* Glassy background */
      border: var(--border-glass); /* Subtle border */
      border-radius: 8px;
      color: var(--info); /* Info color */
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2); /* Softer shadow */
    }

    .btn-secondary:hover {
      background: var(--panel-hover);
      color: var(--accent); /* Hover to accent */
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--info-glow); /* Info glow on hover */
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), rgba(255, 107, 107, 0.8));
      box-shadow: 0 4px 12px var(--danger-glow);
    }

    /* Tracker Specific Styles */
    .tracker-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .exercise-entry {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      margin-bottom: 16px;
      transition: var(--transition);
    }

    .exercise-entry:hover {
      border-color: rgba(255, 255, 255, 0.15);
      background: rgba(0, 0, 0, 0.4);
    }

    /* NEW: Color-Coded Exercise Name */
    .exercise-name-compound {
        color: var(--color-compound) !important;
    }
    .exercise-name-isolation {
        color: var(--color-isolation) !important;
    }
    
    .exercise-entry h4 {
      margin: 0; /* Managed by flex parent */
      font-size: 1.05rem;
    }

    .set-inputs {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .set-input-group {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
    }

    .set-input-group label {
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-width: 60px;
      font-weight: 600;
    }

    .set-input-group input {
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: var(--ink);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.95rem;
      transition: var(--transition);
      -moz-appearance: textfield; /* Hide arrows in Firefox */
    }
    
    .set-input-group input::-webkit-outer-spin-button,
    .set-input-group input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .set-input-group input:focus {
      outline: none;
      border-color: var(--success);
      box-shadow: 0 0 0 3px rgba(81, 207, 102, 0.2);
    }

    .set-input-group input.completed {
      border-color: var(--success);
      background: rgba(81, 207, 102, 0.1);
    }
    
    /* New Swap UI Style */
    .swap-ui {
      display: none; 
      margin-bottom: 12px; 
      padding: 10px; 
      background: rgba(255, 184, 77, 0.1); 
      border-radius: 8px;
      border: 1px dashed var(--accent);
    }
    .swap-ui input {
      width: 100%;
      padding: 8px;
      background: var(--panel);
      border: 1px solid var(--accent); 
      border-radius: 4px;
      color: var(--ink);
      font-family: 'Inter', sans-serif;
    }
    .swap-ui input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-glow);
    }

    /* Specific style for the Swap button next to exercise name */
    .exercise-entry .btn-swap-exercise {
        padding: 8px 14px; /* Slightly smaller padding */
        font-size: 0.8rem; /* Smaller font size */
        background: var(--panel-2); /* Matches secondary button background */
        border: var(--border-glass);
        color: var(--info);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        border-radius: 6px; /* Slightly smaller radius */
        transition: var(--transition);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .exercise-entry .btn-swap-exercise:hover {
        background: var(--panel-hover);
        color: var(--accent);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--info-glow);
    }

    /* NEW: Completion Bar Styles */
    .completion-bar {
        background: var(--panel-2);
        border: var(--border-glass);
        border-radius: 8px;
        height: 30px;
        margin-bottom: 24px;
        overflow: hidden;
        position: relative;
    }
    .completion-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--color-progress), rgba(81, 207, 102, 0.5));
        transition: width 0.5s ease;
    }
    .completion-text {
        position: absolute;
        width: 100%;
        text-align: center;
        line-height: 30px;
        color: var(--ink);
        font-weight: 700;
        font-size: 0.9rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }


    .workout-history {
      margin-top: 32px;
    }

    .history-entry {
      background: rgba(0, 0, 0, 0.3);
      padding: 16px 20px;
      border-radius: 8px;
      border-left: 4px solid var(--success);
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition);
    }

    .history-entry:hover {
      background: rgba(0, 0, 0, 0.4);
      transform: translateX(4px);
    }

    .history-date {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    /* Renamed .history-volume to .history-set-count */
    .history-set-count {
        font-family: 'JetBrains Mono', monospace;
        color: var(--info);
        font-weight: 700;
        font-size: 1.1rem;
    }

    .history-workout {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .history-delete {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: var(--transition);
      margin-left: 10px;
      flex-shrink: 0;
    }

    .history-delete:hover {
      background: rgba(255, 107, 107, 0.2);
    }
    
    /* Custom Message Box Styles */
    #message-box {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--panel);
        border: var(--border-glass);
        border-radius: var(--radius);
        padding: 32px;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
        display: none; 
        max-width: 350px;
        text-align: center;
        backdrop-filter: var(--backdrop-filter);
    }
    #message-box-content {
        margin-bottom: 24px;
        font-weight: 500;
        font-size: 1.1rem;
        color: var(--ink);
    }
    #message-box-buttons {
        display: flex;
        justify-content: center;
        gap: 12px;
    }


    /* Responsive */
    @media (max-width: 1024px) {
      .tab-labels {
        grid-template-columns: repeat(3, 1fr);
      }
      .analytics-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .container {
        margin: 20px;
        padding: 28px 20px;
      }

      .tab-labels {
        grid-template-columns: repeat(2, 1fr);
      }

      h1 {
        font-size: 1.75rem;
        letter-spacing: 2px;
      }

      .phase-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 0.85rem;
      }

      th, td {
        padding: 10px 8px;
      }

      .color-code-box {
        padding: 20px;
      }
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 184, 77, 0.3);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 184, 77, 0.5);
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>20-Week Hyper-Anabolic Protocol (v7)</h1>

    <!-- PURE CSS TAB IMPLEMENTATION --><div class="tab-container">
      <!-- Input Radios (hidden, must be siblings of content) --><input type="radio" name="tabs" id="tab-1" class="tab-input" checked />
      <input type="radio" name="tabs" id="tab-2" class="tab-input" />
      <input type="radio" name="tabs" id="tab-3" class="tab-input" />
      <input type="radio" name="tabs" id="tab-4" class="tab-input" />
      <input type="radio" name="tabs" id="tab-5" class="tab-input" />
      <input type="radio" name="tabs" id="tab-6" class="tab-input" />
      
      <!-- Tab Labels --><div class="tab-labels">
        <label for="tab-1" class="tab-label">📊 Overview</label>
        <label for="tab-2" class="tab-label">💪 Training</label>
        <label for="tab-3" class="tab-label">💉 Pharmacology</label>
        <label for="tab-4" class="tab-label">🍽️ Diet</label>
        <label for="tab-5" class="tab-label">📈 Workout Tracker</label>
        <label for="tab-6" class="tab-label">🔥 Analytics</label>
      </div>

      <hr class="divider" />

      <!-- 1. Overview Content --><section id="content-1" class="tab-content">
        <div class="color-code-box compounds">
          <h2 style="text-align: center;">Mission Objectives: Recomposition & Regrowth</h2>
          <p class="muted" style="text-align:center; margin-bottom:16px;">
            This protocol is engineered to aggressively leverage <strong>myonuclei retention</strong> (muscle memory) over 20 weeks, converting stored energy into high-quality muscle fiber.
          </p>

          <div style="
              background: rgba(0, 0, 0, 0.2);
              padding: 24px;
              border-radius: 12px;
              border: 1px solid rgba(255, 255, 255, 0.05);
              transition: var(--transition);
              margin-top: 20px;
          ">
            <h3>Performance Goals</h3>
            <ul>
              <li><strong>Primary Objective:</strong> Achieve significant <span class="data-label">body recomposition</span> (aggressive fat loss with maximal muscle gain).</li>
              <li><strong>Weakness Eradication:</strong> Systematically eliminate the arm weakness via high-frequency training.</li>
              <li><strong>Initial Target:</strong> Transition from <span class="data-label">205 lb</span> to a lean, conditioned <span class="data-label">215–225 lb</span> by Week 20.</li>
            </ul>
          </div>
          
          <div style="margin-top:32px; padding-top:16px; border-top:1px solid var(--line-2);">
            <h3 style="color:var(--info);">Protocol Phase Architecture</h3>
            <ul>
              <li><strong>Phase 1 (Weeks 1–4):</strong> High volume, lower intensity, tissue stabilization.</li>
              <li><strong>Phase 2 (Weeks 5–12):</strong> Increased load, PPL ×2, Nandrolone initiated for joint support.</li>
              <li><strong>Phase 3 (Weeks 13–20):</strong> Body-part split, RPE 9–10, maximal caloric/compound saturation.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- 2. Training Content --><section id="content-2" class="tab-content">
        <div class="color-code-box training">
          <h2>Training Protocol Overload</h2>
          <p style="color:var(--accent); font-weight:700; text-transform:uppercase; margin:0 0 20px;">
            Primary Focus: Progressive Overload & High-Frequency Arms
          </p>

          <!-- Phase 1 Training --><h3>Phase 1: Re-Awakening (Weeks 1–4)</h3>
          <p class="muted"><strong>RPE 7 (3 reps in reserve), 15–20 Reps.</strong> Focus on mind-muscle connection and controlled negatives (3-second eccentric).</p>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Day</th>
                  <th>Focus</th>
                  <th>Exercise</th>
                  <th>Sets x Reps</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Day 1</td>
                  <td>Upper (Pull Focus)</td>
                  <td>Machine Pullover, Seated Cable Row, Cable Face Pull, Hammer Curl, Cable Tricep Pushdown</td>
                  <td>2x Failure, 2x Failure, 1x Failure, 1x Failure, 1x Failure</td>
                  <td>3s negatives on compound movements. Total muscular failure each set.</td>
                </tr>
                <tr>
                  <td>Day 2</td>
                  <td>Lower (Quad Focus)</td>
                  <td>Leg Extension, Leg Press, Standing Calf Raise, Machine Hip Adduction</td>
                  <td>1x Failure, 2x Failure, 2x Failure, 1x Failure</td>
                  <td>Pre-exhaust with leg extension. Feet low on leg press for quad emphasis.</td>
                </tr>
                <tr>
                  <td>Day 3</td>
                  <td>Upper (Push Focus)</td>
                  <td>Incline Dumbbell Press, Pec Deck Fly, Dumbbell Lateral Raise, Machine Overhead Press</td>
                  <td>2x Failure, 1x Failure, 1x Failure, 2x Failure</td>
                  <td>Controlled eccentric. Focus on stretch and contraction.</td>
                </tr>
                <tr>
                  <td>Day 4</td>
                  <td><strong>OFF</strong></td>
                  <td><strong>REST</strong></td>
                  <td>—</td>
                  <td>Mandatory Mobility/Foam Rolling.</td>
                </tr>
                <tr>
                  <td>Day 5</td>
                  <td>Full Body Primer</td>
                  <td>Goblet Squat, Dumbbell Bench Press, Cable Row, EZ Bar Curl, Pushdown</td>
                  <td>2x Failure, 2x Failure, 2x Failure, 1x Failure, 1x Failure</td>
                  <td>Deep stretch on squat. Arm exercises superset optional.</td>
                </tr>
                <tr>
                  <td>Day 6</td>
                  <td>Lower (Ham Focus)</td>
                  <td>Seated Leg Curl, 45-Degree Hyperextension, Seated Calf Raise, Hanging Leg Raise</td>
                  <td>2x Failure, 2x Failure, 2x Failure, 1x Failure</td>
                  <td>Maximize glute/ham contraction on hyperextensions.</td>
                </tr>
                <tr>
                  <td>Day 7</td>
                  <td>Upper (Volume Pump)</td>
                  <td>Cable Crossover, Dumbbell Pullover, Seated Dumbbell Curl, Rope Tricep Extension</td>
                  <td>1x Failure, 1x Failure, 1x Failure, 1x Failure</td>
                  <td>High frequency arm work. Focus on peak contraction.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Phase 2 Training --><h3>Phase 2: Intensity Drive (Weeks 5–12)</h3>
          <p class="muted"><strong>Complete Muscular Failure.</strong> Introduce Nandrolone. High intensity, low volume.</p>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Day</th>
                  <th>Focus</th>
                  <th>Exercise</th>
                  <th>Sets x Reps</th>
                  <th>Techniques</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Day 1</td>
                  <td>PUSH (Chest/Shoulders/Tri)</td>
                  <td>Barbell Incline Press, Flat Dumbbell Press, Seated Dumbbell OHP, Lateral Raise, Cable Tricep Pushdown, Skull Crusher</td>
                  <td>2x Failure, 2x Failure, 2x Failure, 1x Failure, 1x Failure, 1x Failure + Drop</td>
                  <td>Slow eccentrics on compounds. Drop set on skull crushers to complete failure.</td>
                </tr>
                <tr>
                  <td>Day 2</td>
                  <td>PULL (Back/Biceps)</td>
                  <td>Weighted Pull-up, T-Bar Row, Cable Seated Row, Dumbbell Shrug, Barbell Curl, Cable Curl</td>
                  <td>2x Failure, 2x Failure, 2x Failure, 1x Failure, 1x Failure, 1x Failure</td>
                  <td>Maximum stretch and contraction on rows. Rest-pause on final curl set.</td>
                </tr>
                <tr>
                  <td>Day 3</td>
                  <td>LEGS (Quad Focus)</td>
                  <td>Barbell Squat, Hack Squat/Leg Press, Leg Extension, Walking Lunge</td>
                  <td>2x Failure, 2x Failure, 1x Failure, 1x Failure</td>
                  <td>Full depth squats. Controlled eccentric on leg press.</td>
                </tr>
                <tr>
                  <td>Day 4</td>
                  <td>PUSH (Shoulders/Chest/Tri)</td>
                  <td>Machine Overhead Press, Pec Deck Fly, Cable Lateral Raise, Rope Tricep Extension</td>
                  <td>2x Failure, 1x Failure, 1x Failure, 1x Failure</td>
                  <td>Maximize delt contraction. Stretch emphasis on flyes.</td>
                </tr>
                <tr>
                  <td>Day 5</td>
                  <td>PULL (Thickness/Biceps)</td>
                  <td>Romanian Deadlift, Dumbbell Pullover, Single-Arm Dumbbell Row, Hammer Curl</td>
                  <td>2x Failure, 1x Failure, 2x Failure, 1x Failure</td>
                  <td>Deep hamstring stretch on RDLs. Heavy controlled rows.</td>
                </tr>
                <tr>
                  <td>Day 6</td>
                  <td>LEGS (Ham Focus)</td>
                  <td>Lying Leg Curl, Stiff-Legged Deadlift, Calf Press, Hanging Leg Raise</td>
                  <td>2x Failure, 2x Failure, 2x Failure, 1x Failure</td>
                  <td>Maximum stretch on stiff-legged deadlifts.</td>
                </tr>
                <tr>
                  <td>Day 7</td>
                  <td><strong>OFF</strong></td>
                  <td><strong>REST</strong></td>
                  <td>—</td>
                  <td>Maximize recovery.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Phase 3 Training --><h3>Phase 3: Peak Overload (Weeks 13–20)</h3>
          <p class="muted"><strong>Maximum Intensity - Train to Complete Failure.</strong> Body-part split with advanced techniques.</p>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Day</th>
                  <th>Focus</th>
                  <th>Exercise</th>
                  <th>Sets x Reps</th>
                  <th>Techniques</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Day 1</td>
                  <td>CHEST & CALVES</td>
                  <td>Barbell Flat Bench Press, Incline Dumbbell Press, Cable Crossover, Machine Calf Press</td>
                  <td>2x Failure, 2x Failure, 1x Failure, 2x Failure</td>
                  <td>Forced reps optional on final bench set. 3-5s eccentric on DB press.</td>
                </tr>
                <tr>
                  <td>Day 2</td>
                  <td>BACK</td>
                  <td>Weighted Pull-ups, Barbell Bent-Over Row, Lat Pulldown, Machine Pullover</td>
                  <td>2x Failure, 2x Failure, 2x Failure, 1x Failure</td>
                  <td>Add weight until failure at 6-10 reps. Strict form paramount.</td>
                </tr>
                <tr>
                  <td>Day 3</td>
                  <td>LEGS (Full)</td>
                  <td>Barbell Squat, Leg Press, Seated Leg Curl, Leg Extension</td>
                  <td>2x Failure, 2x Failure + Drop, 2x Failure, 1x Failure</td>
                  <td>Heavy squats. Double drop set on leg press to absolute failure.</td>
                </tr>
                <tr>
                  <td>Day 4</td>
                  <td><strong>OFF</strong></td>
                  <td><strong>ACTIVE RECOVERY</strong></td>
                  <td>—</td>
                  <td>Light cardio, deep stretching, joint mobility work.</td>
                </tr>
                <tr>
                  <td>Day 5</td>
                  <td>SHOULDERS & ARMS</td>
                  <td>Seated Dumbbell Press, Dumbbell Lateral Raise, Bent Over Rear Delt Fly, Barbell Curl, Tricep Extension, Hammer Curl, Rope Pushdown</td>
                  <td>2x Failure, 1x Failure, 1x Failure, 1x Failure, 1x Failure, 1x Failure, 1x Failure</td>
                  <td>Can superset arms (Curl + Extension, Hammer + Pushdown) for efficiency.</td>
                </tr>
                <tr>
                  <td>Day 6</td>
                  <td><strong>OFF</strong></td>
                  <td><strong>REST</strong></td>
                  <td>—</td>
                  <td>Full recovery.</td>
                </tr>
                <tr>
                  <td>Day 7</td>
                  <td><strong>OFF</strong></td>
                  <td><strong>REST</strong></td>
                  <td>—</td>
                  <td>Full recovery.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 3. Pharmacology Content --><section id="content-3" class="tab-content">
        <div class="color-code-box compounds">
          <h2>Compound Protocol</h2>
          <p style="color:var(--danger); font-weight:700; text-transform:uppercase; margin:0 0 20px;">
            EOD Injection Schedule (adjust by bloodwork only)
          </p>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Compound</th>
                  <th>Weekly Dose</th>
                  <th>Phase 1 (Weeks 1–4)</th>
                  <th>Phase 2 (Weeks 5–12)</th>
                  <th>Phase 3 (Weeks 13–20)</th>
                  <th>Rationale</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Testosterone (E/C)</strong></td>
                  <td><span class="data-label">200 mg</span></td>
                  <td>200 mg</td>
                  <td>200 mg</td>
                  <td>200 mg</td>
                  <td>TRT base</td>
                </tr>
                <tr>
                  <td><strong>Primobolan</strong></td>
                  <td><span class="data-label">600 mg</span></td>
                  <td>400 mg</td>
                  <td>600 mg</td>
                  <td>600 mg</td>
                  <td>Clean anabolism / recomp</td>
                </tr>
                <tr>
                  <td><strong>Nandrolone Decanoate</strong></td>
                  <td><span class="data-label">500 mg</span></td>
                  <td>0 mg</td>
                  <td>400 mg</td>
                  <td>500 mg</td>
                  <td>Joint support</td>
                </tr>
                <tr>
                  <td><strong>BPC-157 (Peptide)</strong></td>
                  <td><span class="data-label">500 µg daily</span></td>
                  <td>Daily</td>
                  <td>As needed</td>
                  <td>As needed</td>
                  <td>Proactive tissue repair</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 4. Diet Content --><section id="content-4" class="tab-content">
        <div class="color-code-box nutrition">
          <h2>Nutrition & Recovery Strategy</h2>
          <p style="color:var(--info); font-weight:700; text-transform:uppercase; margin:0 0 20px;">
            Precision Carb Cycling for Hypertrophy & Fat Loss
          </p>

          <div class="phase-grid">
            <div>
              <h3>Macro Constants</h3>
              <ul>
                <li><strong>Protein:</strong> <span class="data-label">308 g minimum</span> (≈1.5 g/lb)</li>
                <li><strong>Sleep:</strong> <span class="data-label">9 hours</span></li>
                <li><strong>Meal Prep:</strong> Non-negotiable for adherence</li>
              </ul>
              <h3>Supplementation</h3>
              <ul>
                <li><strong>Creatine:</strong> 5 g daily</li>
                <li><strong>Intra-Workout:</strong> EAAs + fast carbs (high days)</li>
                <li><strong>Post-Workout:</strong> Protein isolate + <span class="data-label">75–100 g HGC</span> (high days)</li>
                <li><strong>Omega-3s:</strong> 4–6 g EPA/DHA daily</li>
              </ul>
            </div>
            <div style="grid-column: span 2;">
              <h3>Carb Cycling Summary</h3>
              <div class="table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th>Phase</th>
                      <th>Day Type</th>
                      <th>Carbs (C)</th>
                      <th>Fat (F)</th>
                      <th>Calorie Goal</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td rowspan="2"><strong>Phase 1</strong><br/>(Weeks 1–4)</td>
                      <td>High (Training)</td>
                      <td>250 g</td>
                      <td>65 g</td>
                      <td><span class="data-label">~2,900 kcal</span> (slight surplus)</td>
                    </tr>
                    <tr>
                      <td>Low (Rest)</td>
                      <td>50 g</td>
                      <td>80 g</td>
                      <td><span class="data-label">~2,200 kcal</span> (moderate deficit)</td>
                    </tr>
                    <tr>
                      <td rowspan="2"><strong>Phase 2</strong><br/>(Weeks 5–12)</td>
                      <td>High (Training)</td>
                      <td>375 g</td>
                      <td>75 g</td>
                      <td><span class="data-label">~3,500 kcal</span> (solid surplus)</td>
                    </tr>
                    <tr>
                      <td>Low (Rest)</td>
                      <td>75 g</td>
                      <td>90 g</td>
                      <td><span class="data-label">~2,500 kcal</span> (slight deficit)</td>
                    </tr>
                    <tr>
                      <td rowspan="2"><strong>Phase 3</strong><br/>(Weeks 13–20)</td>
                      <td>High (Training)</td>
                      <td>500 g</td>
                      <td>80 g</td>
                      <td><span class="data-label">~4,100 kcal</span> (high anabolic surplus)</td>
                    </tr>
                    <tr>
                      <td>Low (Rest)</td>
                      <td>100 g</td>
                      <td>70 g</td>
                      <td><span class="data-label">~2,300 kcal</span> (sharpening deficit)</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 5. Tracker Content --><section id="content-5" class="tab-content">
        <div class="color-code-box tracker">
          <h2 style="text-align: center;">⏱️ Rest Timer & Workout Tracker</h2>
          <p style="color:var(--success); font-weight:700; text-transform:uppercase; text-align:center; margin:0 0 32px;">
            Track Your Rest Periods & Log Your Workouts
          </p>

          <!-- Rest Timer --><div class="rest-timer-container" style="margin-bottom: 48px;">
            <h3 style="text-align: center; color: var(--accent); margin-bottom: 20px;">Rest Timer</h3>
            <div class="timer-display" id="timerDisplay">0:00</div>
            <div class="timer-controls">
              <button class="timer-preset" onclick="setTimer(30)">30s</button>
              <button class="timer-preset" onclick="setTimer(60)">1min</button>
              <button class="timer-preset" onclick="setTimer(90)">1:30</button>
              <button class="timer-preset" onclick="setTimer(120)">2min</button>
              <button class="timer-preset" onclick="setTimer(180)">3min</button>
            </div>
            <div class="timer-custom">
              <input type="number" id="customMinutes" placeholder="Min" min="0" max="10" value="0" style="width:70px;" />
              <input type="number" id="customSeconds" placeholder="Sec" min="0" max="59" value="0" style="width:70px;" />
              <button class="btn btn-secondary" onclick="setCustomTimer()">Set Custom</button>
            </div>
            <div class="timer-buttons">
              <button class="btn" id="startBtn" onclick="startTimer()">▶️ Start</button>
              <button class="btn btn-danger" onclick="resetTimer()">⏹️ Reset</button>
            </div>
            <div class="timer-progress-bar">
              <div class="timer-progress-fill" id="progressFill"></div>
            </div>
          </div>

          <!-- Fullscreen Toggle Button --><div style="text-align: right; margin-bottom: 24px;" class="full-screen-btn-container">
              <button class="btn btn-secondary" onclick="toggleFullscreen()" style="padding: 8px 16px; font-size: 0.9rem;">
                  Go Fullscreen 🖥️
              </button>
          </div>
          
          <!-- Workout Tracker --><div style="padding-top: 32px; border-top: 2px solid rgba(255, 255, 255, 0.1);">
            <h3 style="text-align: center; color: var(--info); margin-bottom: 24px;">Workout Logger</h3>
            <div class="tracker-controls">
              <div>
                <label for="phase-select" style="display:block; margin-bottom:6px; color:var(--muted); font-size:0.85rem; text-transform:uppercase;">Select Phase</label>
                <select id="phase-select" style="padding: 12px 16px; background: var(--panel-2); border: var(--border-glass); border-radius: 8px; color: var(--ink); font-family: 'Inter', sans-serif; font-size: 0.95rem; min-width: 200px; cursor: pointer;">
                  <option value="phase1">Phase 1: Re-Awakening (Weeks 1-4)</option>
                  <option value="phase2">Phase 2: Intensity Drive (Weeks 5-12)</option>
                  <option value="phase3">Phase 3: Peak Overload (Weeks 13-20)</option>
                </select>
              </div>
              <div>
                <label for="day-select" style="display:block; margin-bottom:6px; color:var(--muted); font-size:0.85rem; text-transform:uppercase;">Select Day</label>
                <select id="day-select" style="padding: 12px 16px; background: var(--panel-2); border: var(--border-glass); border-radius: 8px; color: var(--ink); font-family: 'Inter', sans-serif; font-size: 0.95rem; min-width: 200px; cursor: pointer;">
                  <!-- Populated by JavaScript --></select>
              </div>
              <div>
                <label for="workout-date" style="display:block; margin-bottom:6px; color:var(--muted); font-size:0.85rem; text-transform:uppercase;">Workout Date</label>
                <input type="date" id="workout-date" style="padding: 12px 16px; background: var(--panel-2); border: var(--border-glass); border-radius: 8px; color: var(--ink); font-family: 'Inter', sans-serif; font-size: 0.95rem;" />
              </div>
            </div>
            
            <!-- NEW: Completion Progress Bar -->
            <div class="completion-bar">
                <div id="completionFill" class="completion-fill"></div>
                <div id="completionText" class="completion-text">WORKOUT PROGRESS: 0% Completed</div>
            </div>

            <!-- NEW: Single Exercise Display Container --><div id="current-exercise-container" style="margin-top: 24px;">
              <!-- Single exercise HTML and navigation controls rendered here by JS -->
            </div>

            <div style="display:flex; gap:12px; margin-top:24px; flex-wrap:wrap;">
              <button class="btn" onclick="saveWorkout()">💾 Save Workout</button>
              <button class="btn btn-secondary" onclick="loadWorkout()">📂 Load Last Workout</button>
              <button class="btn btn-danger" onclick="clearWorkout()">🗑️ Clear Form</button>
            </div>

            <div class="workout-history" style="margin-top: 32px;">
              <h3>Workout History (Sets & Summary)</h3>
              <div id="history-list">
                <!-- Populated by JavaScript --></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 6. Analytics Content --><section id="content-6" class="tab-content">
          <div class="color-code-box analytics">
              <h2 style="text-align: center;">🔥 Performance Analytics</h2>
              <p style="color:var(--success); font-weight:700; text-transform:uppercase; text-align:center; margin:0 0 32px;">
                  Track PRs, Set Count, and Strength Trends
              </p>

              <div class="analytics-grid">
                  <div style="grid-column: span 2;">
                      <h3 style="color:var(--info);">Total Set Count Progression (Volume)</h3>
                      <p class="muted">Total number of working sets completed per workout, showing overall volume trend.</p>
                      <div class="chart-container">
                          <canvas id="volumeChart"></canvas>
                      </div>
                  </div>
                  
                  <div id="pr-container">
                      <h3 style="color:var(--accent);">Personal Records (Highest Weight x Reps)</h3>
                      <p class="muted">The heaviest weight and reps achieved in a single set for each exercise.</p>
                      <div id="pr-list" class="pr-list">
                          <p class="muted">Log a workout to see your PRs.</p>
                      </div>
                  </div>
              </div>
              
              <hr class="divider" />
              
              <h2 style="margin-top: 32px;">Exercise-Specific Strength Trends</h2>
              <p class="muted" style="text-align:center; margin-bottom:24px;">Progression of the 4 most frequently logged exercises, tracking best set Effective Strength over time.</p>
              
              <div class="analytics-grid" id="exercise-charts-container">
                  <p class="muted" style="grid-column: span 3; text-align:center;">Log more workouts to see specific exercise charts.</p>
              </div>
              
          </div>
      </section>

    </div>
    <!-- END PURE CSS TAB IMPLEMENTATION --></main>
  
  <!-- Fullscreen Exit Button (Fixed position, only visible in FS mode) --><button class="fullscreen-toggle-button" onclick="toggleFullscreen()" style="display:none;">
      Exit Fullscreen ❌
  </button>
  
  <!-- Custom Message Box Modal --><div id="message-box">
      <div id="message-box-content"></div>
      <div id="message-box-buttons">
          <button class="btn" id="message-box-btn-ok">OK</button>
      </div>
  </div>

  <script>
    // --- CUSTOM MESSAGE BOX FUNCTIONS (Replacing alert/confirm) ---
    function showMessage(message, onConfirm = null) {
        const box = document.getElementById('message-box');
        const content = document.getElementById('message-box-content');
        const buttons = document.getElementById('message-box-buttons');
        let okBtn = document.getElementById('message-box-btn-ok');

        // Clear previous state and ensure base OK button exists
        if (!okBtn) {
            okBtn = document.createElement('button');
            okBtn.id = 'message-box-btn-ok';
            buttons.appendChild(okBtn);
        }
        buttons.innerHTML = '';
        buttons.appendChild(okBtn);
        
        content.innerHTML = message;
        box.style.display = 'block';

        if (onConfirm) {
            // Confirmation dialog
            okBtn.textContent = 'Confirm';
            okBtn.className = 'btn btn-danger';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn btn-secondary';
            
            buttons.appendChild(cancelBtn);

            okBtn.onclick = () => {
                box.style.display = 'none';
                onConfirm(true);
            };
            cancelBtn.onclick = () => {
                box.style.display = 'none';
                onConfirm(false);
            };
        } else {
            // Simple alert
            okBtn.textContent = 'OK';
            okBtn.className = 'btn';
            okBtn.onclick = () => box.style.display = 'none';
        }
    }
    
    // --- REST TIMER LOGIC ---
    let timerInterval = null;
    let timerSeconds = 0;
    let totalSeconds = 0;
    let isPaused = false;
    const timerAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBDGH0fPTgjMGHm7A7+OZRQ0PVa3n8KC9fGgxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZRQ0OVK3n8K1dGQxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZRQ0OVK3n8K1dGQxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZRQ0OVK3n8K1dGQxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZRQwPVK3n8K1dGQxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZRQ0OVK3n8K1dGQxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZRQ0OVK3n8K1dGQxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZRQ0OVK3n8K1dGQxKpuPyvmoeAzCC0fPTgjQGIXLC7+OZ');

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function setTimer(seconds) {
      timerSeconds = seconds;
      totalSeconds = seconds;
      document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('timerDisplay').classList.remove('running', 'finished');
      document.getElementById('startBtn').textContent = '▶️ Start';
      isPaused = false;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function setCustomTimer() {
      const mins = parseInt(document.getElementById('customMinutes').value) || 0;
      const secs = parseInt(document.getElementById('customSeconds').value) || 0;
      const totalSecs = (mins * 60) + secs;
      if (totalSecs > 0) {
        setTimer(totalSecs);
      } else {
        showMessage('Please enter a valid time!');
      }
    }

    function startTimer() {
      const timerDisplay = document.getElementById('timerDisplay');
      const startBtn = document.getElementById('startBtn');

      if (timerSeconds === 0 && !isPaused) {
        showMessage('Please set a timer first!');
        return;
      }

      if (timerInterval) {
        // Pause
        clearInterval(timerInterval);
        timerInterval = null;
        isPaused = true;
        startBtn.textContent = '▶️ Resume';
        timerDisplay.classList.remove('running');
      } else {
        // Start/Resume
        isPaused = false;
        startBtn.textContent = '⏸️ Pause';
        timerDisplay.classList.add('running');
        timerDisplay.classList.remove('finished');

        timerInterval = setInterval(() => {
          timerSeconds--;
          document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);

          // Update progress bar
          const percentage = (timerSeconds / totalSeconds) * 100;
          document.getElementById('progressFill').style.width = percentage + '%';

          if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            timerDisplay.classList.remove('running');
            timerDisplay.classList.add('finished');
            startBtn.textContent = '▶️ Start';

            // Play sound
            try {
              timerAudio.play();
            } catch (e) {
              console.log('Audio play failed:', e);
            }

            // Show notification if supported
            if ('Notification' in window && Notification.permission === 'granted') {
              new Notification('Rest Timer Complete!', {
                body: 'Time to start your next set!',
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="80">⏱️</text></svg>'
              });
            } else {
              showMessage('⏱️ Rest time is up! Ready for your next set!');
            }
          }
        }, 1000);
      }
    }

    function resetTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerSeconds = totalSeconds;
      isPaused = false;
      document.getElementById('timerDisplay').textContent = formatTime(timerSeconds);
      document.getElementById('timerDisplay').classList.remove('running', 'finished');
      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('startBtn').textContent = '▶️ Start';
    }

    // Request notification permission on load
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
    
    // --- FULLSCREEN LOGIC ---
    function toggleFullscreen() {
        const doc = window.document;
        const docEl = doc.documentElement;
        const body = doc.body;

        const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
        const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

        if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
            // Enter Fullscreen
            if (requestFullScreen) {
                requestFullScreen.call(docEl);
            }
        } else {
            // Exit Fullscreen
            if (cancelFullScreen) {
                cancelFullScreen.call(doc);
            }
        }
    }

    // Use a listener to keep CSS class updated for all browsers
    function handleFullscreenChange() {
        const body = document.body;
        if (document.fullscreenElement) {
            body.classList.add('fullscreen-mode');
        } else {
            body.classList.remove('fullscreen-mode');
        }
    }
    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
    document.addEventListener('mozfullscreenchange', handleFullscreenChange);
    document.addEventListener('msfullscreenchange', handleFullscreenChange);


    // --- WORKOUT TRACKER LOGIC ---

    // Configuration data for the workout plan (Updated with type property)
    const workoutData = {
      phase1: {
        day1: { name: "Day 1: Upper (Pull Focus)", exercises: [
          { name: "Machine Pullover", sets: 2, reps: "Failure", type: 'isolation' }, 
          { name: "Seated Cable Row", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Cable Face Pull", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Hammer Curl", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Cable Tricep Pushdown", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day2: { name: "Day 2: Lower (Quad Focus)", exercises: [
          { name: "Leg Extension", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Leg Press", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Standing Calf Raise", sets: 2, reps: "Failure", type: 'isolation' }, 
          { name: "Machine Hip Adduction", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day3: { name: "Day 3: Upper (Push Focus)", exercises: [
          { name: "Incline Dumbbell Press", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Pec Deck Fly", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Dumbbell Lateral Raise", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Machine Overhead Press", sets: 2, reps: "Failure", type: 'compound' }
        ]},
        day5: { name: "Day 5: Full Body Primer", exercises: [
          { name: "Goblet Squat", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Dumbbell Bench Press", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Cable Row", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "EZ Bar Curl", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Pushdown", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day6: { name: "Day 6: Lower (Ham Focus)", exercises: [
          { name: "Seated Leg Curl", sets: 2, reps: "Failure", type: 'isolation' }, 
          { name: "45-Degree Hyperextension", sets: 2, reps: "Failure", type: 'isolation' },
          { name: "Seated Calf Raise", sets: 2, reps: "Failure", type: 'isolation' }, 
          { name: "Hanging Leg Raise", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day7: { name: "Day 7: Upper (Volume Pump)", exercises: [
          { name: "Cable Crossover", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Dumbbell Pullover", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Seated Dumbbell Curl", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Rope Tricep Extension", sets: 1, reps: "Failure", type: 'isolation' }
        ]}
      },
      phase2: {
        day1: { name: "Day 1: PUSH", exercises: [
          { name: "Barbell Incline Press", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Flat Dumbbell Press", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Seated Dumbbell OHP", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Lateral Raise", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Cable Tricep Pushdown", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Skull Crusher", sets: 1, reps: "Failure + Drop", type: 'isolation' }
        ]},
        day2: { name: "Day 2: PULL", exercises: [
          { name: "Weighted Pull-up", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "T-Bar Row", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Cable Seated Row", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Dumbbell Shrug", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Barbell Curl", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Cable Curl", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day3: { name: "Day 3: LEGS (Quad)", exercises: [
          { name: "Barbell Squat", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Hack Squat", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Leg Extension", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Walking Lunge", sets: 1, reps: "Failure", type: 'compound' }
        ]},
        day4: { name: "Day 4: PUSH", exercises: [
          { name: "Machine Overhead Press", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Pec Deck Fly", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Cable Lateral Raise", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Rope Tricep Extension", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day5: { name: "Day 5: PULL", exercises: [
          { name: "Romanian Deadlift", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Dumbbell Pullover", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Single-Arm DB Row", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Hammer Curl", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day6: { name: "Day 6: LEGS (Ham)", exercises: [
          { name: "Lying Leg Curl", sets: 2, reps: "Failure", type: 'isolation' }, 
          { name: "Stiff-Legged Deadlift", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Calf Press", sets: 2, reps: "Failure", type: 'isolation' }, 
          { name: "Hanging Leg Raise", sets: 1, reps: "Failure", type: 'isolation' }
        ]}
      },
      phase3: {
        day1: { name: "Day 1: CHEST & CALVES", exercises: [
          { name: "Barbell Flat Bench", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Incline Dumbbell Press", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Cable Crossover", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Machine Calf Press", sets: 2, reps: "Failure", type: 'isolation' }
        ]},
        day2: { name: "Day 2: BACK", exercises: [
          { name: "Weighted Pull-ups", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Barbell Bent-Over Row", sets: 2, reps: "Failure", type: 'compound' },
          { name: "Lat Pulldown", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Machine Pullover", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day3: { name: "Day 3: LEGS (Full)", exercises: [
          { name: "Barbell Squat", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Leg Press", sets: 2, reps: "Failure + Drop", type: 'compound' },
          { name: "Seated Leg Curl", sets: 2, reps: "Failure", type: 'isolation' }, 
          { name: "Leg Extension", sets: 1, reps: "Failure", type: 'isolation' }
        ]},
        day5: { name: "Day 5: SHOULDERS & ARMS", exercises: [
          { name: "Seated Dumbbell Press", sets: 2, reps: "Failure", type: 'compound' }, 
          { name: "Dumbbell Lateral Raise", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Bent Over Rear Delt Fly", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Barbell Curl", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Tricep Extension", sets: 1, reps: "Failure", type: 'isolation' }, 
          { name: "Hammer Curl", sets: 1, reps: "Failure", type: 'isolation' },
          { name: "Rope Pushdown", sets: 1, reps: "Failure", type: 'isolation' }
        ]}
      }
    };

    let volumeChartInstance = null;
    let exerciseChartInstances = [];
    
    // --- NEW STATE MANAGEMENT FOR SINGLE EXERCISE VIEW ---
    let currentExIndex = 0; 
    let activeWorkoutPlan = null; 
    let loadedWorkoutData = null; // Stores data loaded from history for pre-filling inputs
    let totalPlannedSets = 0; // NEW: Total sets in the current selected workout
    // CRITICAL FIX: currentSessionData now holds all entered data in memory 
    let currentSessionData = {}; // {exIndex: {name: '...', notes: '...', sets: {setNum: {weight, reps, tonnage}}}}

    // Initialize tracker and analytics on page load
    function initTracker() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('workout-date').value = today;
      updateDaySelect();
      loadHistory();
      
      // Analytics initialization
      updatePRs();
      renderCharts();
    }

    // Update day select based on phase
    function updateDaySelect() {
      const phaseSelect = document.getElementById('phase-select');
      const daySelect = document.getElementById('day-select');
      const phase = phaseSelect.value;
      
      // Clear loaded data whenever the plan selection changes
      loadedWorkoutData = null; 
      currentSessionData = {}; // CRITICAL: Reset session data when plan changes

      daySelect.innerHTML = '';
      const days = workoutData[phase];

      for (const [key, value] of Object.entries(days)) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = value.name;
        daySelect.appendChild(option);
      }
      
      loadWorkoutForm();
    }

    // --- SWIPE LOGIC ---
    let touchstartX = 0;
    let touchendX = 0;

    function checkSwipeDirection() {
      const swipeThreshold = 50; // Minimum pixel distance for a recognized swipe
      if (touchendX < touchstartX - swipeThreshold) {
        // Swipe Left (Next Exercise)
        nextExercise();
      } else if (touchendX > touchstartX + swipeThreshold) {
        // Swipe Right (Previous Exercise)
        prevExercise();
      }
    }

    function attachSwipeListeners(element) {
        // Remove existing listeners to prevent duplicates
        element.removeEventListener('touchstart', handleTouchStart, false);
        element.removeEventListener('touchend', handleTouchEnd, false);
        
        element.addEventListener('touchstart', handleTouchStart, false);
        element.addEventListener('touchend', handleTouchEnd, false);
    }
    
    function handleTouchStart(e) {
        touchstartX = e.changedTouches[0].screenX;
    }
    
    function handleTouchEnd(e) {
        touchendX = e.changedTouches[0].screenX;
        checkSwipeDirection();
    }

    // --- PROGRESS BAR LOGIC ---
    function calculateCompletionPercentage() {
        if (!activeWorkoutPlan || totalPlannedSets === 0) return 0;

        let setsCompleted = 0;

        // Iterate through the session data to count completed sets (CRITICAL FIX: reads from session state)
        // Need to count all sets recorded across all exercises
        activeWorkoutPlan.exercises.forEach((exercise, index) => {
            const sessionExData = currentSessionData[index];
            if (sessionExData && sessionExData.sets) {
                setsCompleted += Object.keys(sessionExData.sets).length;
            }
        });

        return Math.floor((setsCompleted / totalPlannedSets) * 100);
    }

    function updateCompletionIndicator() {
        const percentage = calculateCompletionPercentage();
        const fill = document.getElementById('completionFill');
        const text = document.getElementById('completionText');

        if (fill) fill.style.width = percentage + '%';
        if (text) text.textContent = `WORKOUT PROGRESS: ${percentage}% Completed`;
    }

    // --- NAVIGATION FUNCTIONS ---
    function nextExercise() {
        if (!activeWorkoutPlan) return;
        
        // CRITICAL: Save current visible data before navigating away
        saveVisibleSessionData();

        if (currentExIndex < activeWorkoutPlan.exercises.length - 1) {
            currentExIndex++;
            renderCurrentExercise(true);
        } else {
            showMessage('You have reached the last exercise of the workout!');
        }
    }

    function prevExercise() {
        if (!activeWorkoutPlan) return;
        
        // CRITICAL: Save current visible data before navigating away
        saveVisibleSessionData();

        if (currentExIndex > 0) {
            currentExIndex--;
            renderCurrentExercise(true);
        } else {
            showMessage('You are on the first exercise.');
        }
    }
    
    // Load workout plan and set initial state
    function loadWorkoutForm() {
      const phase = document.getElementById('phase-select').value;
      const day = document.getElementById('day-select').value;
      const displayContainer = document.getElementById('current-exercise-container');

      if (!day) {
        displayContainer.innerHTML = '<p class="muted" style="text-align:center;">Please select a Phase and Day.</p>';
        return;
      }

      const workout = workoutData[phase][day];
      activeWorkoutPlan = workout; 
      
      currentExIndex = 0; // Reset to the first exercise
      
      // Calculate total planned sets for the progress bar
      totalPlannedSets = workout.exercises.reduce((sum, ex) => sum + (parseInt(ex.sets) || 0), 0);
      
      // CRITICAL FIX: Pre-initialize session data for all exercises
      workout.exercises.forEach((exercise, index) => {
          if (!currentSessionData[index]) {
              currentSessionData[index] = {
                  name: exercise.name, 
                  notes: '', 
                  sets: {}
              };
          } else {
              // Ensure name is up-to-date from plan if not custom
              if (currentSessionData[index].name === currentSessionData[index].originalName || !currentSessionData[index].originalName) {
                currentSessionData[index].name = exercise.name;
              }
              currentSessionData[index].originalName = exercise.name;
          }
      });
      
      renderCurrentExercise();
      updateCompletionIndicator();
    }
    
    // Renders the current exercise based on currentExIndex
    function renderCurrentExercise(scrolled = false) {
        if (!activeWorkoutPlan || activeWorkoutPlan.exercises.length === 0) return;

        const exercise = activeWorkoutPlan.exercises[currentExIndex];
        const index = currentExIndex;
        const numSets = parseInt(exercise.sets) || 1;
        const displayContainer = document.getElementById('current-exercise-container');
        
        // Load current session data for this exercise
        const sessionExData = currentSessionData[index] || {sets: {}, notes: '', name: exercise.name};
        const exName = sessionExData.name || exercise.name;
        const notes = sessionExData.notes || '';
        
        // Determine color class based on exercise type
        const typeClass = `exercise-name-${exercise.type || 'compound'}`;
        const typeLabel = exercise.type ? 
            `<span class="data-label" style="background: ${exercise.type === 'compound' ? 'rgba(255, 184, 77, 0.1)' : 'rgba(79, 195, 247, 0.1)'}; color: ${exercise.type === 'compound' ? 'var(--accent)' : 'var(--info)'}; margin-left: 10px;">${exercise.type.toUpperCase()}</span>` 
            : '';

        let html = `
          <div class="exercise-entry" id="ex-entry-${index}">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 12px;">
                <h4 id="ex-name-${index}" class="${typeClass}">${exName} ${typeLabel}</h4>
                <button class="btn-swap-exercise" onclick="showSwapModal(${index}, '${exercise.name}')" id="swap-btn-${index}">
                    ${exName !== exercise.name ? 'Unswap 🔄' : 'Swap 🔄'}
                </button>
            </div>
            <p class="muted" style="margin:0 0 12px;">Target: ${exercise.sets} sets × ${exercise.reps}</p>
            
            <div class="swap-ui" id="swap-ui-${index}">
                <label for="swap-input-${index}" class="muted" style="display:block; margin-bottom:4px; color:var(--accent); font-size: 0.8rem;">Substitute Name:</label>
                <input type="text" id="swap-input-${index}" placeholder="Enter new exercise name" value="${exName}" />
                <button class="btn btn-secondary" style="margin-top:8px; padding:8px 14px; font-size:0.8rem;" onclick="applySwap(${index}, '${exercise.name}')">Apply Substitute</button>
            </div>

            <div class="set-inputs">
        `;

        for (let i = 1; i <= numSets; i++) {
          const set = sessionExData.sets ? sessionExData.sets[i] : null;
          const weightValue = set ? set.weight : '';
          const repsValue = set ? set.reps : '';
          const completedClass = set ? 'completed' : '';

          html += `
            <div class="set-input-group">
              <label>Set ${i}</label>
              <input 
                type="number" 
                placeholder="Weight (kg/lb)" 
                id="ex${index}_set${i}_weight"
                oninput="handleSetInput(${index}, ${i})"
                style="flex: 1; min-width: 100px;"
                min="0"
                step="0.1"
                value="${weightValue}"
                class="${completedClass}"
              />
              <input 
                type="number" 
                placeholder="Reps" 
                id="ex${index}_set${i}_reps"
                oninput="handleSetInput(${index}, ${i})"
                style="flex: 1; min-width: 100px;"
                min="0"
                step="1"
                value="${repsValue}"
                class="${completedClass}"
              />
            </div>
          `;
        }

        html += `
            </div>
            
            <h5 style="font-size: 0.95rem; color: var(--muted); margin-top: 20px; margin-bottom: 8px;">Quick Notes:</h5>
            <textarea id="ex${index}_notes" oninput="saveNotes(${index})" placeholder="e.g., Felt heavy today, use lighter load next time. (Optional)" rows="2" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--line); border-radius: 8px; color: var(--ink); resize: vertical;">${notes}</textarea>

          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 20px;">
              <button class="btn btn-secondary" onclick="prevExercise()" ${currentExIndex === 0 ? 'disabled' : ''}>← Previous</button>
              <div id="exercise-counter" class="muted" style="line-height: 2.5; font-weight: 600;">Exercise ${currentExIndex + 1} of ${activeWorkoutPlan.exercises.length}</div>
              <button class="btn btn-secondary" onclick="nextExercise()" ${currentExIndex === activeWorkoutPlan.exercises.length - 1 ? 'disabled' : ''}>Next →</button>
          </div>
        `;

        displayContainer.innerHTML = html;
        
        // Attach swipe listeners to the new content container
        attachSwipeListeners(document.getElementById(`ex-entry-${index}`));
        
        // Scroll to top of the exercise on navigation
        if (scrolled) {
            displayContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    // NEW: Function to save the notes content to session data
    function saveNotes(exIndex) {
        const notesInput = document.getElementById(`ex${exIndex}_notes`);
        if (notesInput) {
            // Check for existence is not needed due to pre-initialization, but as a safeguard
            if (!currentSessionData[exIndex]) {
                const exercise = activeWorkoutPlan.exercises[exIndex];
                currentSessionData[exIndex] = {sets: {}, notes: '', name: exercise.name, originalName: exercise.name};
            }
            currentSessionData[exIndex].notes = notesInput.value.trim();
        }
    }
    
    // NEW: Function to save the currently visible form inputs to session data
    function saveVisibleSessionData() {
        if (!activeWorkoutPlan) return;
        
        const index = currentExIndex;
        const exercisePlan = activeWorkoutPlan.exercises[index];
        const numSets = parseInt(exercisePlan.sets) || 0;
        
        // CRITICAL: Ensure session structure exists and save name/notes
        // This relies on the currentSessionData[index] existing from loadWorkoutForm()
        const sessionEntry = currentSessionData[index];
        if (!sessionEntry) return;

        saveNotes(index); // Save notes right before navigation
        
        let sets = {};
        for (let i = 1; i <= numSets; i++) {
            const weightInput = document.getElementById(`ex${index}_set${i}_weight`);
            const repsInput = document.getElementById(`ex${index}_set${i}_reps`);
            
            if (weightInput && repsInput) {
                const weight = parseFloat(weightInput.value);
                const reps = parseInt(repsInput.value);
                
                if (weight > 0 && reps > 0) {
                    sets[i] = {
                        weight: weight,
                        reps: reps,
                        tonnage: calculateSetTonnage(weight, reps) 
                    };
                } else {
                    delete sets[i];
                }
            }
        }
        sessionEntry.sets = sets;
    }


    function autoAdvanceFocus(exIndex, setNum) {
        const activeElement = document.activeElement;
        const currentInputIsWeight = activeElement.id.endsWith('_weight');

        // 1. Try focusing the Reps input for the current set
        if (currentInputIsWeight) {
            const nextRepsInput = document.getElementById(`ex${exIndex}_set${setNum}_reps`);
            if (nextRepsInput) {
                nextRepsInput.focus();
                return;
            }
        }
        
        const exercisePlan = activeWorkoutPlan.exercises[exIndex];
        const numSets = parseInt(exercisePlan.sets) || 1;

        // 2. Try focusing the Weight input for the next set (of the current exercise)
        const nextSetNum = setNum + 1;
        if (nextSetNum <= numSets) {
            const nextWeightInput = document.getElementById(`ex${exIndex}_set${nextSetNum}_weight`);
            if (nextWeightInput) {
                nextWeightInput.focus();
                return;
            }
        }

        // 3. If all sets in the current exercise are complete, move to the next exercise
        if (exIndex < activeWorkoutPlan.exercises.length - 1) {
            // Save current data (handled in handleSetInput and nextExercise)
            nextExercise();
            // Automatically focus the first input of the new exercise
            setTimeout(() => {
                const nextExWeightInput = document.getElementById(`ex${exIndex + 1}_set1_weight`);
                if (nextExWeightInput) {
                    nextExWeightInput.focus();
                }
            }, 100);
            return;
        }

        // 4. If all exercises are complete, focus the Save button
        const saveBtn = document.querySelector('.btn');
        if (saveBtn) {
            saveBtn.focus();
        }
    }

    function handleSetInput(exIndex, setNum) {
      const weightInput = document.getElementById(`ex${exIndex}_set${setNum}_weight`);
      const repsInput = document.getElementById(`ex${exIndex}_set${setNum}_reps`);

      const weight = parseFloat(weightInput.value);
      const reps = parseInt(repsInput.value);
      
      const isValid = weight > 0 && reps > 0;
      const wasCompleted = weightInput.classList.contains('completed');
      
      // CRITICAL: Ensure session structure exists (already done in loadWorkoutForm, but safeguard)
      if (!currentSessionData[exIndex]) {
          const exercise = activeWorkoutPlan.exercises[exIndex];
          currentSessionData[exIndex] = {sets: {}, notes: '', name: exercise.name, originalName: exercise.name};
      }

      if (isValid) {
        weightInput.classList.add('completed');
        repsInput.classList.add('completed');

        // Update session data - Set Weight/Reps
        const setTonnage = calculateSetTonnage(weight, reps);
        currentSessionData[exIndex].sets[setNum] = {
            weight: weight,
            reps: reps,
            tonnage: setTonnage 
        };

        // Check if the timer should start (Auto-start rest timer)
        if (!wasCompleted) {
             setTimer(90); 
             startTimer(); 
        }
        
        updateCompletionIndicator();
        autoAdvanceFocus(exIndex, setNum);

      } else {
        weightInput.classList.remove('completed');
        repsInput.classList.remove('completed');
        
        // Clear session data if cleared/invalidated
        if (currentSessionData[exIndex] && currentSessionData[exIndex].sets[setNum]) {
             delete currentSessionData[exIndex].sets[setNum];
        }

        updateCompletionIndicator();
      }
    }


    // --- SWAP EXERCISE LOGIC ---
    function showSwapModal(exIndex, originalName) {
        // CRITICAL: Save current state before modifying the name field
        saveVisibleSessionData();

        const swapUI = document.getElementById(`swap-ui-${exIndex}`);
        const swapInput = document.getElementById(`swap-input-${exIndex}`);
        const exNameEl = document.getElementById(`ex-name-${exIndex}`);
        const swapBtn = document.getElementById(`swap-btn-${exIndex}`);
        
        // Clean up type label if present
        swapInput.value = exNameEl.textContent.replace(/\s(COMPOUND|ISOLATION)\s*$/g, '').trim(); 
        swapUI.style.display = 'block';
        swapInput.focus();
        
        swapBtn.textContent = 'Cancel Swap';
        swapBtn.classList.remove('btn-secondary'); 
        swapBtn.classList.add('btn-danger'); 
        swapBtn.onclick = () => hideSwapModal(exIndex, originalName);
    }
    
    function hideSwapModal(exIndex, originalName) {
        const swapUI = document.getElementById(`swap-ui-${exIndex}`);
        const swapBtn = document.getElementById(`swap-btn-${exIndex}`);
        
        swapUI.style.display = 'none';
        
        swapBtn.textContent = 'Swap 🔄';
        swapBtn.classList.remove('btn-danger'); 
        swapBtn.onclick = () => showSwapModal(exIndex, originalName);
    }

    function applySwap(exIndex, originalName) {
        const swapInput = document.getElementById(`swap-input-${exIndex}`);
        const newName = swapInput.value.trim();
        const exNameEl = document.getElementById(`ex-name-${exIndex}`);
        const exercisePlan = activeWorkoutPlan.exercises[exIndex];
        
        // Get the type label HTML to append it back
        const typeLabel = exercisePlan.type ? 
            `<span class="data-label" style="background: ${exercisePlan.type === 'compound' ? 'rgba(255, 184, 77, 0.1)' : 'rgba(79, 195, 247, 0.1)'}; color: ${exercisePlan.type === 'compound' ? 'var(--accent)' : 'var(--info)'}; margin-left: 10px;">${exercisePlan.type.toUpperCase()}</span>` 
            : '';

        if (newName && newName.toLowerCase() !== originalName.toLowerCase()) {
            exNameEl.innerHTML = newName + typeLabel;
            
            // CRITICAL: Update name in session data
            const sessionEntry = currentSessionData[exIndex];
            if (sessionEntry) sessionEntry.name = newName;

            showMessage(`✅ Exercise substituted: ${originalName} -> ${newName}`);
        } else {
             exNameEl.innerHTML = originalName + typeLabel; 
             
             // CRITICAL: Reset name in session data
             const sessionEntry = currentSessionData[exIndex];
             if (sessionEntry) sessionEntry.name = originalName;

             showMessage(`Exercise name reset to: ${originalName}`);
        }
        
        hideSwapModal(exIndex, originalName);
    }
    
    // Utility function to calculate tonnage for a set (Weight * Reps) - Used for PR tracking
    function calculateSetTonnage(weight, reps) {
        if (isNaN(weight) || isNaN(reps) || weight <= 0 || reps <= 0) return 0;
        return weight * reps;
    }

    // Save workout
    function saveWorkout() {
      const phase = document.getElementById('phase-select').value;
      const day = document.getElementById('day-select').value;
      const date = document.getElementById('workout-date').value;
      
      if (!activeWorkoutPlan) {
          showMessage('Please select a phase and day first!');
          return;
      }

      // CRITICAL: Save the currently visible form data one last time before processing
      saveVisibleSessionData();

      let totalWorkoutSetCount = 0; 

      const workoutLog = {
        date: date,
        phase: phase,
        day: day,
        workoutName: activeWorkoutPlan.name,
        totalVolume: 0, 
        exercises: []
      };

      // Iterate through the full planned workout and read exclusively from currentSessionData
      activeWorkoutPlan.exercises.forEach((exercise, index) => {
          const sessionExData = currentSessionData[index];
          
          if (!sessionExData || !sessionExData.sets) return; // Skip if no session data or no sets logged

          const sets = [];
          let exerciseSetCount = 0;
          
          // Determine the name to save (original or swapped)
          const nameToSave = sessionExData.name || exercise.name;
          const isSwapped = nameToSave !== exercise.name;
          
          // Iterate over sets saved in the session data
          Object.values(sessionExData.sets).forEach(set => {
            if (set.weight > 0 && set.reps > 0) {
              sets.push(set);
              exerciseSetCount += 1;
              totalWorkoutSetCount += 1;
            }
          });

          if (exerciseSetCount > 0) {
            workoutLog.exercises.push({
              name: nameToSave, 
              originalName: exercise.name,
              isSwapped: isSwapped,
              sets: sets,
              totalSetCount: exerciseSetCount,
              notes: sessionExData.notes || '',
              type: exercise.type 
            });
          }
      });
      

      if (totalWorkoutSetCount === 0) {
        showMessage('Please enter at least one valid set (Weight > 0 and Reps > 0) before saving!');
        return;
      }
      
      workoutLog.totalVolume = totalWorkoutSetCount;

      let workouts = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
      workouts.unshift(workoutLog);

      if (workouts.length > 100) { 
        workouts = workouts.slice(0, 100);
      }

      localStorage.setItem('workoutHistory', JSON.stringify(workouts));
      
      showMessage(`✅ Workout saved successfully! Total Sets: ${totalWorkoutSetCount}`);
      loadHistory();
      clearWorkout(); // Clears session data
      updatePRs(); 
      renderCharts(); 
    }

    // Loads saved data into a temp structure, then calls renderCurrentExercise
    function loadWorkout() {
      const phase = document.getElementById('phase-select').value;
      const day = document.getElementById('day-select').value;

      const workouts = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
      const lastWorkout = workouts.find(w => w.phase === phase && w.day === day);

      if (!lastWorkout) {
        showMessage('No previous workout found for this day!');
        return;
      }
      
      // CRITICAL: Transform the loaded history into the currentSessionData structure
      currentSessionData = {};
      lastWorkout.exercises.forEach((savedEx, index) => {
          const setsMap = {};
          // Map saved array of sets back to an object keyed by set number (1-based)
          savedEx.sets.forEach((set, setIndex) => {
              setsMap[setIndex + 1] = set;
          });
          
          // CRITICAL: Ensure the current plan is loaded so we can get metadata (type)
          if (!activeWorkoutPlan || activeWorkoutPlan.name !== lastWorkout.workoutName) {
              const phaseSelect = document.getElementById('phase-select');
              const daySelect = document.getElementById('day-select');
              
              // Force select the matching plan to ensure activeWorkoutPlan is correct
              phaseSelect.value = lastWorkout.phase;
              // We can't auto-set daySelect.value unless it's populated, which happens in updateDaySelect
              updateDaySelect(); 
              daySelect.value = lastWorkout.day;
              // Recalculate activeWorkoutPlan based on selections
              activeWorkoutPlan = workoutData[lastWorkout.phase][lastWorkout.day];
              totalPlannedSets = activeWorkoutPlan.exercises.reduce((sum, ex) => sum + (parseInt(ex.sets) || 0), 0);
          }


          currentSessionData[index] = {
              name: savedEx.name,
              originalName: savedEx.originalName,
              notes: savedEx.notes || '',
              sets: setsMap
          };
      });

      // Ensure the correct exercise is rendered and populated
      currentExIndex = 0;
      renderCurrentExercise();
      
      showMessage('📂 Last workout loaded!');
    }
    
    // Clear entire workout session (form data, not history)
    function clearWorkout() {
        currentSessionData = {};
        currentExIndex = 0;
        loadWorkoutForm(); // Re-renders the first exercise with a fresh state
    }

    // Load history
    function loadHistory() {
      const historyList = document.getElementById('history-list');
      const workouts = JSON.parse(localStorage.getItem('workoutHistory') || '[]');

      if (workouts.length === 0) {
        historyList.innerHTML = '<p class="muted">No workouts logged yet. Start tracking your progress!</p>';
        return;
      }

      let html = '';
      workouts.slice(0, 15).forEach((workout, index) => {
        let summary = workout.exercises.length > 0 ? 
            `${workout.exercises.length} Exercises` : 'No exercises logged';

        // NOTE: workout.totalVolume is now the set count
        html += `
          <div class="history-entry">
            <div>
              <div class="history-date">${new Date(workout.date).toLocaleDateString()}</div>
              <div class="history-workout">${workout.workoutName} - ${summary}</div>
            </div>
            <div style="display:flex; align-items:center;">
                <div class="history-set-count">${workout.totalVolume} Sets</div>
                <button class="history-delete" onclick="deleteWorkout(${index})" title="Delete workout">🗑️</button>
            </div>
          </div>
        `;
      });

      historyList.innerHTML = html;
    }

    // Delete workout (using custom confirmation)
    function deleteWorkout(index) {
        showMessage('Are you sure you want to delete this workout entry? This cannot be undone.', (confirmed) => {
            if (confirmed) {
                let workouts = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
                workouts.splice(index, 1);
                localStorage.setItem('workoutHistory', JSON.stringify(workouts));
                loadHistory();
                updatePRs();
                renderCharts();
                showMessage('Entry deleted.');
            }
        });
    }
    
    // --- ANALYTICS / PR / CHARTING LOGIC ---
    
    let prCache = {};

    function updatePRs() {
        const workouts = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
        const prs = {}; // {exerciseName: {weight: 0, reps: 0, tonnage: 0, date: ''}}
        
        workouts.forEach(workout => {
            workout.exercises.forEach(exercise => {
                const exName = exercise.name;
                
                exercise.sets.forEach(set => {
                    // Use tonnage for PR calculation (strength/intensity metric)
                    const setTonnage = set.tonnage;
                    
                    if (!prs[exName] || setTonnage > prs[exName].tonnage) {
                        prs[exName] = {
                            weight: set.weight,
                            reps: set.reps,
                            tonnage: setTonnage,
                            date: workout.date
                        };
                    }
                });
            });
        });
        
        prCache = prs;
        localStorage.setItem('personalRecords', JSON.stringify(prs));
        renderPRs();
    }
    
    function renderPRs() {
        const prList = document.getElementById('pr-list');
        const prs = prCache;
        
        // Sort by Tonnage descending
        const sortedPrs = Object.entries(prs).sort(([, a], [, b]) => b.tonnage - a.tonnage);
        
        if (sortedPrs.length === 0) {
            prList.innerHTML = '<p class="muted">Log a workout to see your PRs.</p>';
            return;
        }
        
        let html = '';
        sortedPrs.forEach(([name, pr]) => {
            html += `
                <div class="pr-item">
                    <div class="pr-exercise">${name}</div>
                    <div class="pr-details">
                        <div class="pr-volume">${pr.weight} lbs x ${pr.reps}</div>
                        <div class="muted">Effective Strength: ${pr.tonnage.toFixed(0)} (${new Date(pr.date).toLocaleDateString()})</div>
                    </div>
                </div>
            `;
        });
        
        prList.innerHTML = html;
    }

    function renderCharts() {
        const workouts = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
        if (workouts.length === 0) {
            document.getElementById('exercise-charts-container').innerHTML = 
                '<p class="muted" style="grid-column: span 3; text-align:center;">Log more workouts to see specific exercise charts.</p>';
            return;
        }

        // --- 1. Total Set Count Chart ---
        
        // Sort workouts by date ascending for chronological chart plotting
        const sortedWorkouts = workouts.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const labels = sortedWorkouts.map(w => new Date(w.date).toLocaleDateString());
        // Data is now the set count (stored in totalVolume)
        const data = sortedWorkouts.map(w => w.totalVolume);
        
        const ctxVolume = document.getElementById('volumeChart').getContext('2d');
        if (volumeChartInstance) volumeChartInstance.destroy(); // Destroy previous instance
        
        volumeChartInstance = new Chart(ctxVolume, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Workout Sets',
                    data: data,
                    borderColor: 'var(--success)',
                    backgroundColor: 'rgba(81, 207, 102, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Total Set Count Trend', color: 'var(--ink)' }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        grid: { color: 'var(--line)' },
                        ticks: { color: 'var(--muted)', precision: 0 } // Ensure Y-axis shows whole numbers for sets
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: 'var(--muted)' }
                    }
                }
            }
        });
        
        // --- 2. Exercise-Specific Charts (Tracking Tonnage PR over time for strength trend) ---
        
        // Collect frequency of exercises
        const exerciseFrequency = {};
        workouts.forEach(w => w.exercises.forEach(e => {
            exerciseFrequency[e.name] = (exerciseFrequency[e.name] || 0) + 1;
        }));
        
        // Get top 4 most frequent exercises
        const sortedFrequency = Object.entries(exerciseFrequency).sort(([, a], [, b]) => b - a);
        const topExercises = sortedFrequency.slice(0, 4).map(([name]) => name);
        
        const container = document.getElementById('exercise-charts-container');
        container.innerHTML = ''; // Clear previous charts

        exerciseChartInstances.forEach(chart => chart.destroy());
        exerciseChartInstances = [];
        
        if (topExercises.length === 0) {
            container.innerHTML = '<p class="muted" style="grid-column: span 3; text-align:center;">Log more workouts to see specific exercise charts.</p>';
            return;
        }

        const colors = ['var(--accent)', 'var(--info)', 'var(--danger)', 'var(--success)'];

        topExercises.forEach((exName, index) => {
            // Filter historical data for this exercise
            const exHistory = sortedWorkouts.map(w => {
                const ex = w.exercises.find(e => e.name === exName);
                if (ex) {
                    // Find the best set tonnage (highest single-set intensity) for that workout day
                    const bestSetTonnage = ex.sets.reduce((max, set) => Math.max(max, set.tonnage), 0);
                    return { date: w.date, tonnage: bestSetTonnage };
                }
                return { date: w.date, tonnage: null };
            }).filter(item => item.tonnage !== null);
            
            if (exHistory.length < 2) return; // Need at least two data points for a trend
            
            const chartData = {
                labels: exHistory.map(h => new Date(h.date).toLocaleDateString()),
                datasets: [{
                    label: 'Best Set Effective Strength',
                    data: exHistory.map(h => h.tonnage.toFixed(0)),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length].replace(')', ', 0.3)').replace('rgb', 'rgba'),
                    fill: false,
                    tension: 0.1,
                    pointRadius: 5,
                    pointBackgroundColor: colors[index % colors.length]
                }]
            };

            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<canvas id="chart-${index}"></canvas>`;
            container.appendChild(chartDiv);

            const ctx = document.getElementById(`chart-${index}`).getContext('2d');
            const newChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `${exName} - Best Set Effective Strength Trend`, color: 'var(--ink)' }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'var(--line)' },
                            ticks: { color: 'var(--muted)' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--muted)' }
                        }
                    }
                }
            });
            exerciseChartInstances.push(newChart);
        });
        
        if (container.children.length === 0) {
             container.innerHTML = '<p class="muted" style="grid-column: span 3; text-align:center;">Log more workouts to see specific exercise charts.</p>';
        }
    }


    // Event listeners
    document.getElementById('phase-select').addEventListener('change', updateDaySelect);
    document.getElementById('day-select').addEventListener('change', loadWorkoutForm);
    document.getElementById('tab-6').addEventListener('change', () => {
        // Only run chart rendering when the analytics tab is selected
        if (document.getElementById('tab-6').checked) {
            renderCharts();
            renderPRs();
        }
    });

    // Initialize on page load
    window.addEventListener('load', initTracker);
  </script>
</body>
</html>
